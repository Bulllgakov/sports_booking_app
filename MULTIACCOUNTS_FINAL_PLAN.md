# ФИНАЛЬНЫЙ ПЛАН ВНЕДРЕНИЯ МУЛЬТИРАСЧЕТОВ ТБАНК

## ⚠️ ВАЖНЫЕ ИЗМЕНЕНИЯ В МОДЕЛИ КОМИССИЙ

### Ключевое открытие:
Т-Банк вычитает комиссию эквайринга **из возмещения платформе**, а не из выплаты клубу. Это требует корректировки финансовой модели.

### Новая структура комиссий:
- **Для клубов отображается:**
  - Комиссия платформы: 1.0%
  - Эквайринг и онлайн-касса: 2.6%
  - **Итого: 3.6%** (вычитается из выплаты клубу)

- **Реальная модель для платформы:**
  - Получаем от клуба: 3.6%
  - Т-Банк забирает реальный эквайринг (0.5-2.2% в зависимости от способа оплаты)
  - **Чистая прибыль платформы = 1.0% + (2.6% - реальный_эквайринг)**

### Преимущества новой модели:
1. Прозрачность для клубов (видят разбивку комиссий)
2. Дополнительная маржа для платформы (разница между заявленным и реальным эквайрингом)
3. Защита от роста ставок эквайринга

## Общая концепция
- **Мультирасчеты** - основной и единственный способ приема платежей для всех новых клубов
- **Прямой эквайринг** - исключение только для существующих 3 клубов и по решению суперадмина
- Все платежи проходят через платформу с автоматическими ежедневными выплатами
- **ВАЖНО**: Комиссия эквайринга вычитается Т-Банком из возмещения платформе, а не из выплаты клубу

## ЭТАП 1: Реорганизация раздела "Управление клубом" (3 дня)

### 1.1. Создание вкладок в ClubManagement.tsx
```
Управление клубом
├── Основная информация (название, адрес, телефон, описание, удобства)
├── Реквизиты (все юридические и банковские данные)
├── Фотографии (логотип и фото клуба)
└── Настройки бронирования (режим работы, длительности, слоты)
```

### 1.2. Вкладка "Реквизиты" - добавить новые поля:
**Существующие поля:**
- Тип организации (ИП/ООО/АО/НКО/Самозанятый)
- Юридическое наименование
- ИНН
- КПП
- ОГРН/ОГРНИП
- Юридический адрес
- Наименование банка
- БИК банка
- Корр. счет
- Расчетный счет
- ФИО руководителя
- Должность руководителя

**Новые обязательные поля для Мультирасчетов:**
- ✅ Email для финансовых уведомлений (financeEmail)
- ✅ Телефон для финансовых вопросов (financePhone)
- ✅ ОКПО (okpo) - опционально
- ✅ ОКВЭД (okved) - опционально

### 1.3. Обновление схемы данных venues:
```javascript
{
  // Новые поля для реквизитов
  financeEmail: string,
  financePhone: string,
  okpo: string,
  okved: string,
  
  // Поля для Мультирасчетов
  paymentType: 'multiaccounts' | 'direct', // По умолчанию 'multiaccounts'
  platformCommissionPercent: number, // Комиссия платформы (по умолчанию 1.0%)
  acquiringCommissionPercent: number, // Комиссия эквайринга и кассы (по умолчанию 2.6%)
  // Общая комиссия для клуба = platformCommissionPercent + acquiringCommissionPercent
  
  multiaccountsConfig: {
    status: 'not_configured' | 'pending' | 'active' | 'rejected',
    recipientId: string, // ID получателя в Тбанк
    registeredAt: Timestamp,
    activatedAt: Timestamp,
    rejectionReason: string,
    lastChecked: Timestamp
  }
}
```

## ЭТАП 2: Переработка раздела "Настройки оплаты" (2 дня)

### 2.1. Новая логика PaymentSettings.tsx:
- По умолчанию показываем только Мультирасчеты
- Проверка заполненности реквизитов
- Кнопка подачи заявки на подключение
- Отображение статуса подключения
- Для суперадмина: возможность переключить на прямой эквайринг

### 2.2. Статусы и состояния:
1. **Реквизиты не заполнены** → Кнопка "Заполнить реквизиты"
2. **Реквизиты заполнены** → Кнопка "Подать заявку"
3. **Заявка на рассмотрении** → Статус "На модерации"
4. **Мультирасчеты активны** → Отображение:
   - Комиссия платформы: 1.0%
   - Эквайринг и онлайн-касса: 2.6%
   - Общая комиссия: 3.6%
5. **Заявка отклонена** → Причина отказа и кнопка повторной подачи

## ЭТАП 3: Интеграция с Тбанк API (1 неделя)

### 3.1. Cloud Functions:

#### registerClubInMultiaccounts
```javascript
// Регистрация клуба в системе Мультирасчетов
- Валидация обязательных полей
- Отправка данных в Тбанк API
- Создание recipientId
- Обновление статуса в БД
```

#### tbankMultiaccountsWebhook
```javascript
// Обработка платежей через Мультирасчеты
- Получение уведомления о платеже
- Расчет комиссий:
  * platformCommissionPercent (1.0%) - комиссия платформы
  * acquiringCommissionPercent (2.6%) - заявленная комиссия эквайринга
  * Реальная комиссия эквайринга из ответа Т-Банка (для аналитики)
- Обновление статуса бронирования
- Логирование для будущих выплат
```

#### processDailyPayouts
```javascript
// Ежедневные автоматические выплаты (запуск в 10:00)
- Сбор всех оплаченных бронирований за вчера
- Расчет комиссий и вычетов:
  * Общая сумма к выплате клубу = Сумма платежа - (platformCommissionPercent + acquiringCommissionPercent)
  * В API Т-Банка отправляется общая комиссия (3.6%)
  * Т-Банк вычитает реальную комиссию эквайринга из возмещения платформе
  * Платформа получает: 1.0% + (2.6% - реальная_комиссия_эквайринга)
- Вычет долгов по возвратам
- Вычет стоимости подписки (для CRM и ПРОФИ тарифов)
- Отправка выплаты через Тбанк API
- Email уведомление клубу
```

### 3.2. Обработка существующих клубов:
```javascript
// Migration script - однократный запуск
const existingClubs = [
  'club_id_1', // Название клуба 1
  'club_id_2', // Название клуба 2  
  'club_id_3'  // Название клуба 3
];

// Установить для них paymentType: 'direct'
for (const clubId of existingClubs) {
  await updateDoc(doc(db, 'venues', clubId), {
    paymentType: 'direct',
    multiaccountsConfig: {
      status: 'not_applicable',
      note: 'Клуб использует собственный эквайринг'
    }
  });
}

// Все новые клубы автоматически получают paymentType: 'multiaccounts'
```

## ЭТАП 4: Расширение раздела "Финансы" (3 дня)

### 4.1. Новая вкладка "Выплаты" (только для Мультирасчетов):
- История всех выплат
- Детализация по каждой выплате
- Разбивка комиссий (банк, платформа)
- Информация о вычетах (возвраты, подписка)
- Экспорт в Excel

### 4.2. Структура данных payouts collection:
```javascript
{
  venueId: string,
  date: Timestamp,
  bookings: string[], // ID бронирований
  totalGrossAmount: number, // Сумма от клиентов
  platformFee: number, // Комиссия платформы (1.0%)
  acquiringFee: number, // Заявленная комиссия эквайринга (2.6%)
  actualAcquiringFee: number, // Реальная комиссия эквайринга от Т-Банка
  refundsDeducted: number, // Вычеты за возвраты
  subscriptionFeeDeducted: number, // Оплата подписки
  finalPayoutAmount: number, // К выплате клубу
  status: 'pending' | 'completed' | 'failed',
  tbankPayoutId: string,
  
  // Для аналитики платформы
  platformNetProfit: number // Чистая прибыль = platformFee + (acquiringFee - actualAcquiringFee)
}
```

## ЭТАП 5: Обработка возвратов (3 дня)

### 5.1. Логика возвратов:
- **До выплаты** → Простой возврат, отмена включения в выплату
- **После выплаты** → Создание долга, вычет из следующих выплат

### 5.2. Структура данных venue_debts:
```javascript
{
  venueId: string,
  bookingId: string,
  debtAmount: number,
  originalRefund: number,
  createdAt: Timestamp,
  status: 'pending' | 'paid' | 'partial',
  paidAt: Timestamp,
  payoutId: string // В какой выплате был учтен долг
}
```

## ЭТАП 6: Тестирование и запуск (1 неделя)

### 6.1. Тестовое окружение:
- Создать тестовые клубы
- Проверить процесс регистрации
- Тестовые платежи
- Проверка выплат
- Тестирование возвратов

### 6.2. Поэтапный запуск:
1. **Пилот** - 1-2 новых клуба
2. **Расширение** - все новые клубы
3. **Миграция** - предложение существующим клубам (опционально)

## ЭТАП 7: Аналитика платформы для суперадминов (2 дня)

### 7.1. Раздел "Аналитика платформы":
Доступен только суперадминистраторам для мониторинга реальной прибыльности.

#### Вкладки и метрики:
1. **По клубам:**
   - Валовый доход от каждого клуба
   - Комиссия платформы (1.0%)
   - Заявленная комиссия эквайринга (2.6%)
   - Реальная комиссия эквайринга (из API Т-Банка)
   - Чистая прибыль = 1.0% + (2.6% - реальная_комиссия)
   - Маржинальность по клубу

2. **По способам оплаты:**
   - Анализ реальных ставок эквайринга по картам/СБП
   - Выявление наиболее прибыльных методов оплаты
   - Рекомендации по оптимизации

3. **Детальные транзакции:**
   - Полный список всех платежей
   - Разница между заявленной и реальной комиссией
   - Экспорт для финансовой отчетности

### 7.2. Ключевые показатели:
- **Net Profit Margin** = (Чистая прибыль / Валовый доход) × 100%
- **Effective Platform Rate** = Реальная доходность платформы
- **Acquiring Spread** = Заявленный эквайринг - Реальный эквайринг

## ЭТАП 8: Документация и обучение (2 дня)

### 8.1. Документация для клубов:
- Инструкция по заполнению реквизитов
- FAQ по Мультирасчетам
- Видео-инструкция

### 8.2. Внутренняя документация:
- Процедуры поддержки
- Обработка проблемных ситуаций
- Мониторинг и алерты

## Ключевые метрики успеха

1. **Технические:**
   - 100% успешных выплат
   - Время обработки платежа < 5 сек
   - Доступность системы > 99.9%

2. **Бизнес метрики:**
   - Конверсия регистрация → активация > 80%
   - Время от заявки до активации < 2 дней
   - Количество обращений в поддержку < 5%

3. **Финансовые:**
   - Чистая прибыль платформы (с учетом разницы в комиссиях)
   - Маржинальность по каждому способу оплаты
   - ROI = (Чистая прибыль / Валовый доход) × 100%
   - Средний чек
   - Объем транзакций

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| Отказ Тбанк API | Низкая | Высокое | Retry механизм, очереди, уведомления |
| Ошибки в расчетах | Средняя | Высокое | Тщательное тестирование, логирование |
| Недовольство клубов комиссией | Средняя | Среднее | Прозрачность, качество сервиса |
| Проблемы с возвратами | Низкая | Среднее | Четкая логика, резервный фонд |

## Чек-лист готовности к запуску

### Технический чек-лист:
- [ ] Обновлена схема БД с новыми полями
- [ ] Создана вкладка "Реквизиты" в управлении клубом
- [ ] Переработан раздел "Настройки оплаты"
- [ ] Интегрирован Тбанк API
- [ ] Настроены Cloud Functions для выплат
- [ ] Реализована обработка возвратов
- [ ] Добавлена вкладка "Выплаты" в финансах
- [ ] Протестирована вся цепочка платежей

### Организационный чек-лист:
- [ ] Подписан договор с Тбанк
- [ ] Получены API ключи
- [ ] Настроены webhook URL
- [ ] Подготовлена документация
- [ ] Обучена команда поддержки
- [ ] Уведомлены существующие клубы

### Юридический чек-лист:
- [ ] Обновлена оферта
- [ ] Подготовлено соглашение для клубов
- [ ] Проверено соответствие 54-ФЗ
- [ ] Настроена фискализация

## Timeline

```
Неделя 1: Этапы 1-2 (UI изменения)
Неделя 2: Этап 3 (Интеграция API)  
Неделя 3: Этапы 4-5 (Финансы и возвраты)
Неделя 4: Этап 6 (Тестирование) + Этап 7 (Аналитика)
Неделя 5: Этап 8 (Документация) + Запуск
```

## Команда

- **Frontend**: Обновление UI компонентов
- **Backend**: Cloud Functions и интеграция
- **DevOps**: Настройка окружения и мониторинг
- **QA**: Тестирование всех сценариев
- **Support**: Подготовка к поддержке клубов

---

**Статус**: План готов к реализации
**Приоритет**: Высокий
**Дата начала**: По согласованию
**Ожидаемая дата запуска**: Через 5 недель после начала