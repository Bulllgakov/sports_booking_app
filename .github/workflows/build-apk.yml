name: Build APK

# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø—Ä–∏ push –≤ main –≤–µ—Ç–∫—É –∏–ª–∏ –≤—Ä—É—á–Ω—É—é
on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
      
      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Java (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è Android)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.6'
          channel: 'stable'
      
      # –®–∞–≥ 4: –ü–æ–ª—É—á–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Flutter
      - name: Get dependencies
        run: flutter pub get
      
      # –®–∞–≥ 5: –°–æ–±–∏—Ä–∞–µ–º Debug APK
      - name: Build Debug APK
        run: flutter build apk --debug
      
      # –®–∞–≥ 6: –°–æ–±–∏—Ä–∞–µ–º Release APK
      - name: Build Release APK
        run: flutter build apk --release
      
      # –®–∞–≥ 7: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º APK —Ñ–∞–π–ª—ã –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
      - name: Rename APK files
        run: |
          mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/allcourt-debug.apk
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/allcourt-release.apk
      
      # –®–∞–≥ 8: –ó–∞–≥—Ä—É–∂–∞–µ–º Debug APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: allcourt-debug-apk
          path: build/app/outputs/flutter-apk/allcourt-debug.apk
      
      # –®–∞–≥ 9: –ó–∞–≥—Ä—É–∂–∞–µ–º Release APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç
      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: allcourt-release-apk
          path: build/app/outputs/flutter-apk/allcourt-release.apk
      
      # –®–∞–≥ 10: –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ (–µ—Å–ª–∏ —ç—Ç–æ push –≤ main)
      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/app/outputs/flutter-apk/*.apk"
          tag: v1.0.${{ github.run_number }}
          name: –í—Å–µ –ö–æ—Ä—Ç—ã v1.0.${{ github.run_number }}
          body: |
            ## üì± –í—Å–µ –ö–æ—Ä—Ç—ã - –ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
            
            ### –ß—Ç–æ –Ω–æ–≤–æ–≥–æ:
            - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–±–æ—Ä–∫–∞ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–¥–∞
            - Commit: ${{ github.sha }}
            
            ### –°–∫–∞—á–∞—Ç—å:
            - **allcourt-debug.apk** - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–±–æ–ª—å—à–∏–π —Ä–∞–∑–º–µ—Ä, —Å –æ—Ç–ª–∞–¥–∫–æ–π)
            - **allcourt-release.apk** - –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–º–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä, –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω)
            
            ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
            1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
            2. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ
          draft: false
          prerelease: false
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}