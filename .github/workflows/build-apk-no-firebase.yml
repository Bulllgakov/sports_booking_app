name: Build APK (No Firebase)

# –í—Ä–µ–º–µ–Ω–Ω—ã–π workflow –¥–ª—è —Å–±–æ—Ä–∫–∏ APK –±–µ–∑ Firebase
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build APK without Firebase
    runs-on: ubuntu-latest
    
    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout code
        uses: actions/checkout@v4
      
      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Java (—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–ª—è Android)
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      # –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Flutter
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.3'
          channel: 'stable'
      
      # –®–∞–≥ 4: –£–¥–∞–ª—è–µ–º Firebase –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ pubspec.yaml
      - name: Remove Firebase dependencies
        run: |
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π pubspec.yaml –±–µ–∑ Firebase
          cp pubspec.yaml pubspec.yaml.backup
          sed -i '/firebase_core/d' pubspec.yaml
          sed -i '/firebase_auth/d' pubspec.yaml
          sed -i '/cloud_firestore/d' pubspec.yaml
          sed -i '/firebase_storage/d' pubspec.yaml
          sed -i '/firebase_messaging/d' pubspec.yaml
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ —É–¥–∞–ª–∏–ª–∏
          echo "Removed Firebase dependencies from pubspec.yaml"
      
      # –®–∞–≥ 5: –£–¥–∞–ª—è–µ–º Google Services –ø–ª–∞–≥–∏–Ω
      - name: Remove Google Services plugin
        run: |
          # –£–¥–∞–ª—è–µ–º google-services –ø–ª–∞–≥–∏–Ω –∏–∑ app/build.gradle.kts
          sed -i '/google-services/d' android/app/build.gradle.kts
          
          # –£–¥–∞–ª—è–µ–º classpath –∏–∑ build.gradle.kts
          sed -i '/google-services/d' android/build.gradle.kts
          sed -i '/buildscript/,/}/d' android/build.gradle.kts
          
          # –£–¥–∞–ª—è–µ–º google-services.json
          rm -f android/app/google-services.json
          
          echo "Removed Google Services configuration"
      
      # –®–∞–≥ 6: –ü–æ–ª—É—á–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Flutter
      - name: Get dependencies
        run: flutter pub get
      
      # –®–∞–≥ 7: –°–æ–±–∏—Ä–∞–µ–º Debug APK
      - name: Build Debug APK
        run: flutter build apk --debug --no-tree-shake-icons
      
      # –®–∞–≥ 8: –°–æ–±–∏—Ä–∞–µ–º Release APK
      - name: Build Release APK
        run: flutter build apk --release --no-tree-shake-icons
      
      # –®–∞–≥ 9: –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º APK —Ñ–∞–π–ª—ã
      - name: Rename APK files
        run: |
          mv build/app/outputs/flutter-apk/app-debug.apk build/app/outputs/flutter-apk/allcourt-debug-no-firebase.apk
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/allcourt-release-no-firebase.apk
      
      # –®–∞–≥ 10: –ó–∞–≥—Ä—É–∂–∞–µ–º APK –∫–∞–∫ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: Upload APK files
        uses: actions/upload-artifact@v4
        with:
          name: allcourt-apk-no-firebase
          path: build/app/outputs/flutter-apk/*.apk
          retention-days: 30
      
      # –®–∞–≥ 11: –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑
      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: ncipollo/release-action@v1
        with:
          artifacts: "build/app/outputs/flutter-apk/*.apk"
          tag: v1.0.${{ github.run_number }}-no-firebase
          name: –í—Å–µ –ö–æ—Ä—Ç—ã v1.0.${{ github.run_number }} (No Firebase)
          body: |
            ## üì± –í—Å–µ –ö–æ—Ä—Ç—ã - –¢–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞
            
            ‚ö†Ô∏è **–≠—Ç–æ —Ç–µ—Å—Ç–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –ë–ï–ó Firebase**
            
            ### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
            - ‚úÖ –í—Å–µ —ç–∫—Ä–∞–Ω—ã –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
            - ‚úÖ UI –∏ –¥–∏–∑–∞–π–Ω
            - ‚ùå –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è (–æ—Ç–∫–ª—é—á–µ–Ω–∞)
            - ‚ùå –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (–æ—Ç–∫–ª—é—á–µ–Ω–æ)
            
            ### –°–∫–∞—á–∞—Ç—å:
            - **allcourt-debug-no-firebase.apk** - –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            - **allcourt-release-no-firebase.apk** - –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            
            ### –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
            1. –°–∫–∞—á–∞–π—Ç–µ APK —Ñ–∞–π–ª –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω
            2. –†–∞–∑—Ä–µ—à–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∫—É –∏–∑ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
            3. –û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ
            
            ### –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:
            –ù—É–∂–Ω–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Firebase –¥–ª—è –ø–æ–ª–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.
          draft: false
          prerelease: true
          allowUpdates: true
          token: ${{ secrets.GITHUB_TOKEN }}