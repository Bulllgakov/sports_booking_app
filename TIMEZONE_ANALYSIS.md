# Анализ работы с часовыми поясами в Sports Booking App

## Текущая ситуация

### Как сейчас работает система

1. **Хранение в Firestore**:
   - Даты хранятся как `Firestore Timestamp` (после нашего обновления)
   - Timestamp в Firestore **всегда хранится в UTC**
   - Время (startTime) хранится как строка `'HH:mm'` (например, '10:00')

2. **Проблема с часовыми поясами**:
   - **Дата**: Firestore Timestamp автоматически конвертируется в локальное время браузера
   - **Время**: Хранится как строка без информации о часовом поясе
   
   Это означает, что если менеджер находится в другом часовом поясе:
   - Дата может отображаться некорректно (например, 23:00 в Москве = 01:00 следующего дня в Екатеринбурге)
   - Время '10:00' будет интерпретироваться как 10:00 в часовом поясе менеджера, а не клуба

## Примеры проблем

### Сценарий 1: Менеджер в другом часовом поясе
- Клуб находится в Москве (UTC+3)
- Менеджер находится в Дубае (UTC+4)
- Клиент хочет забронировать корт на 10:00 по московскому времени
- Менеджер создает бронирование на 10:00
- В системе сохраняется 10:00, но это будет 10:00 по времени Дубая
- Клиент придет в 10:00 по Москве, а бронирование записано на 09:00 по Москве

### Сценарий 2: Переход даты
- Клуб в Москве (UTC+3)
- Менеджер в Лондоне (UTC+0)
- Менеджер создает бронирование на 1:00 ночи 15 марта
- В Лондоне это еще 14 марта 22:00
- Бронирование может быть записано на неверную дату

## Рекомендуемое решение

### Вариант 1: Хранить часовой пояс клуба (РЕКОМЕНДУЕТСЯ)

1. **Добавить в настройки клуба (venue)**:
```typescript
interface Venue {
  // ... существующие поля
  timezone: string  // Например: 'Europe/Moscow', 'Asia/Dubai'
}
```

2. **При создании бронирования**:
```typescript
// Получаем часовой пояс клуба
const venueTimezone = venue.timezone || 'Europe/Moscow'

// Создаем дату и время в часовом поясе клуба
const bookingDateTime = DateTime.fromObject({
  year: date.getFullYear(),
  month: date.getMonth() + 1,
  day: date.getDate(),
  hour: parseInt(startTime.split(':')[0]),
  minute: parseInt(startTime.split(':')[1])
}, { zone: venueTimezone })

// Сохраняем в Firestore как UTC
const timestamp = Timestamp.fromDate(bookingDateTime.toJSDate())
```

3. **При отображении**:
```typescript
// Конвертируем обратно в часовой пояс клуба
const bookingDateTime = DateTime.fromJSDate(timestamp.toDate())
  .setZone(venueTimezone)

// Показываем время в часовом поясе клуба
const displayTime = bookingDateTime.toFormat('HH:mm')
const displayDate = bookingDateTime.toFormat('dd.MM.yyyy')
```

### Вариант 2: Всегда работать в UTC

1. **Хранить все в UTC**
2. **Показывать время с указанием часового пояса**:
   - "10:00 (Московское время)"
   - "14:00 (UTC+3)"

### Вариант 3: Хранить локальное время клуба (текущий подход с улучшениями)

1. **Явно указывать, что время - это время клуба**
2. **Добавить предупреждение для менеджеров**:
   - "Внимание: время указывается по часовому поясу клуба (Москва, UTC+3)"
3. **Показывать двойное время**:
   - "10:00 (время клуба) / 11:00 (ваше локальное время)"

## Необходимые изменения для Варианта 1

### 1. Обновить схему базы данных
- Добавить поле `timezone` в коллекцию `venues`
- Установить значение по умолчанию 'Europe/Moscow'

### 2. Установить библиотеку для работы с часовыми поясами
```bash
npm install luxon
npm install @types/luxon
```

### 3. Создать утилиты для работы с часовыми поясами
```typescript
// src/utils/timezone.ts
import { DateTime } from 'luxon'
import { Timestamp } from 'firebase/firestore'

export function createBookingTimestamp(
  date: Date, 
  time: string, 
  timezone: string
): Timestamp {
  const [hours, minutes] = time.split(':').map(Number)
  const dt = DateTime.fromObject({
    year: date.getFullYear(),
    month: date.getMonth() + 1,
    day: date.getDate(),
    hour: hours,
    minute: minutes
  }, { zone: timezone })
  
  return Timestamp.fromDate(dt.toJSDate())
}

export function formatBookingTime(
  timestamp: Timestamp,
  timezone: string
): { date: string, time: string } {
  const dt = DateTime.fromJSDate(timestamp.toDate())
    .setZone(timezone)
  
  return {
    date: dt.toFormat('yyyy-MM-dd'),
    time: dt.toFormat('HH:mm')
  }
}
```

### 4. Обновить интерфейс администратора
- Добавить выбор часового пояса в настройки клуба
- Показывать часовой пояс клуба при создании бронирования
- Опционально: показывать время в двух часовых поясах

## Быстрое решение (минимальные изменения)

Если нужно быстрое решение без больших изменений:

1. **Добавить предупреждение в админ-панели**:
```typescript
// В CreateBookingModal
<Alert severity="info">
  Внимание: Время указывается по часовому поясу расположения клуба.
  Текущее время клуба: {getCurrentClubTime()}
</Alert>
```

2. **Показывать часовой пояс клуба**:
```typescript
// В заголовке календаря бронирований
<Typography variant="subtitle2">
  Часовой пояс: Москва (UTC+3)
</Typography>
```

3. **Документировать поведение**:
- Добавить в документацию для менеджеров
- Объяснить, что время всегда указывается по месту расположения клуба

## Вывод

Текущая система работает корректно, если все понимают, что время указывается по месту расположения клуба. Однако для избежания путаницы рекомендуется:

1. **Краткосрочно**: Добавить явные указания о часовом поясе в интерфейсе
2. **Долгосрочно**: Реализовать Вариант 1 с хранением часового пояса клуба и корректной конвертацией