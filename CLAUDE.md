# CLAUDE.md - Документация для Claude AI

## Информация о проекте
**AllCourt** - платформа для управления бронированиями спортивных кортов (падел, теннис, бадминтон).

## Технологический стек
- **Frontend:** React + TypeScript + Vite
- **Backend:** Firebase (Firestore, Functions, Auth, Storage)
- **Mobile:** Flutter
- **Hosting:** Firebase Hosting
- **Payment:** YooKassa, T-Bank

## Структура проекта
```
/src
  /components     - React компоненты
  /pages         
    /admin       - Страницы админки
    /public      - Публичные страницы для клиентов
  /services      - Firebase сервисы
  /utils         - Утилиты
/functions       - Cloud Functions
/lib            - Flutter приложение
/dist           - Собранные файлы
  /admin        - Админка
  /fm           - Финансовая модель (защищена паролем)
```

## Важные особенности

### Работа с датами
- Все даты в Firestore хранятся как Timestamp в UTC
- При создании/редактировании используем: `new Date(Date.UTC(year, month-1, day, 0, 0, 0))`
- Для отображения в UI используем `normalizeDateInClubTZ()` из `/src/utils/clubDateTime.ts`

### Редактирование бронирований
- Доступно только администраторам в попапе деталей бронирования
- Можно изменить: корт, дату, длительность, время
- Проверка доступности слотов в реальном времени
- История изменений сохраняется в `paymentHistory`
- Цена не меняется при редактировании

### Финансовая модель (/fm)
- **URL:** https://allcourt.ru/fm
- **Пароль:** BULAT
- Содержит детальную финансовую модель с комиссией 1%
- Защищена паролем, сессия сохраняется до закрытия браузера

## Команды для разработки

### Локальная разработка
```bash
npm run dev:admin    # Запуск админки
npm run dev:public   # Запуск публичной части
```

### Сборка и деплой
```bash
npm run build:admin        # Сборка админки
firebase deploy --only hosting  # Деплой на хостинг
```

### Тестирование
```bash
npm run lint         # Проверка линтером
npm run typecheck    # Проверка типов
```

## Firebase Functions

### Основные функции
- `initBookingPayment` - Инициализация платежа
- `yookassaWebhook` - Обработка webhook от YooKassa
- `validateBookingRequest` - Валидация лимитов бронирования
- `processRefund` - Обработка возвратов

## Роутинг (firebase.json)

### Админка и клиентские страницы
- `/admin/**` → `/admin/index.html`
- `/club/**` → `/admin/index.html`
- `/fm/**` → `/fm/index.html` (финансовая модель)

### API endpoints
- `/api/webhooks/yookassa` → Cloud Function

## Платежная интеграция

### Поддерживаемые провайдеры
- YooKassa (основной)
- T-Bank (альтернативный)

### URL для настройки в платежных системах
- **Webhook URL:** https://allcourt.ru/api/webhooks/yookassa
- **Return URL:** Настраивается для каждого платежа индивидуально

## Безопасность

### Роли пользователей
- `superadmin` - полный доступ
- `admin` - управление клубом
- `trainer` - ограниченный доступ (только просмотр)

### Защищенные страницы
- `/fm` - финансовая модель (пароль: BULAT)

## Известные проблемы и решения

### Проблема с датами в календаре
**Проблема:** Старые бронирования отображаются на день раньше
**Решение:** При редактировании даты используется UTC формат, что исправляет отображение

### Firebase Auth visibility error
**Проблема:** `auth/visibility-check-was-unavailable`
**Решение:** Очистить кеш браузера или использовать инкогнито режим

## Контакты и поддержка
- **GitHub Issues:** https://github.com/anthropics/claude-code/issues
- **Firebase Console:** https://console.firebase.google.com/project/sports-booking-app-1d7e5

## Последние обновления (Август 2025)

### Функционал редактирования бронирований
- Добавлена возможность редактировать корт, дату, длительность и время
- Реализована проверка доступности в реальном времени
- История изменений отображается в деталях бронирования

### Финансовая модель
- Создан защищенный лендинг на /fm
- Детальная модель с комиссией 1% от бронирований
- Прогнозы на 3 года с unit economics

### Исправления
- Корректное сохранение дат в UTC для календаря
- Улучшено отображение URL в настройках оплаты
- Исправлен returnUrl для успешной оплаты