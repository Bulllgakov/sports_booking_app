# CLAUDE.md - Документация для Claude AI

## Информация о проекте
**AllCourt** - платформа для управления бронированиями спортивных кортов (падел, теннис, бадминтон).

## Технологический стек
- **Frontend:** React + TypeScript + Vite
- **Backend:** Firebase (Firestore, Functions, Auth, Storage)
- **Mobile:** Flutter
- **Hosting:** Firebase Hosting
- **Payment:** YooKassa, T-Bank

## Структура проекта
```
/src
  /components     - React компоненты
    /showcase    - Компоненты витрины (Header, Footer, ClubCard и др.)
  /pages         
    /admin       - Страницы админки
    /public      - Публичные страницы для клиентов
  /services      - Firebase сервисы
  /utils         - Утилиты
/functions       - Cloud Functions
/lib            - Flutter приложение
/public
  /business      - B2B лендинг для клубов
  /logo          - Логотипы
  /images        - Изображения
/dist           - Собранные файлы после npm run build
  /admin        - Админка (SPA)
  /demo         - Демо версия админки
  /showcase     - Витрина клубов (B2C)
  /business     - B2B лендинг
  /fm           - Финансовая модель (защищена паролем)
  /logo         - Логотипы (копируются в корень для общего доступа)
  /images       - Изображения (копируются в корень для общего доступа)
```

## Важные особенности

### Работа с датами
- Все даты в Firestore хранятся как Timestamp в UTC
- При создании/редактировании используем: `new Date(Date.UTC(year, month-1, day, 0, 0, 0))`
- Для отображения в UI используем `normalizeDateInClubTZ()` из `/src/utils/clubDateTime.ts`

### Редактирование бронирований
- Доступно только администраторам в попапе деталей бронирования
- Можно изменить: корт, дату, длительность, время
- Проверка доступности слотов в реальном времени
- История изменений сохраняется в `paymentHistory`
- Цена не меняется при редактировании

### Финансовая модель (/fm)
- **URL:** https://allcourt.ru/fm
- **Пароль:** BULAT
- Содержит детальную финансовую модель с комиссией 1%
- Защищена паролем, сессия сохраняется до закрытия браузера

## Важные функции и компоненты

### Модальное окно создания бронирования
- **Файл:** `/src/components/CreateBookingModal.tsx`
- **Ключевые состояния:**
  - `bookingType` - тип бронирования (individual/group)
  - `groupParticipants` - массив участников групповой тренировки
  - `maxParticipants` - максимальное количество участников
  - `isPublicGroup` - флаг открытой/закрытой группы
- **Важно:** При закрытии модалки все состояния должны сбрасываться в useEffect

### Календарь бронирований
- **Файл:** `/src/pages/admin/BookingsManagement.tsx`
- **Режимы отображения:**
  - `viewMode` - переключение День/Неделя
  - `calendarMode` - По кортам/По тренеру
- **Стили сетки:**
  - Gap между ячейками: `#d1d5db`
  - Высота заголовков: `44px`
  - Ширина колонок в режиме День: `minmax(80px, 120px)`

### Обработка платежей
- **YooKassa:** `/functions/src/billing/initBookingPayment.ts`
- **T-Bank:** `/functions/src/multiaccounts/`
- **Webhook:** `/api/webhooks/yookassa`

## Команды для разработки

### Локальная разработка
```bash
npm run dev:admin     # Запуск админки на localhost:8080
npm run dev:demo      # Запуск демо версии
npm run dev:showcase  # Запуск витрины на localhost:5174
```

### Сборка и деплой
```bash
npm run build              # Полная сборка всех приложений
npm run build:admin        # Сборка только админки
npm run build:demo         # Сборка только демо
npm run build:showcase     # Сборка только витрины
firebase deploy --only hosting  # Деплой на хостинг
```

### Тестирование
```bash
npm run lint         # Проверка линтером
npm run typecheck    # Проверка типов
```

## Firebase Functions

### Основные функции
- `initBookingPayment` - Инициализация платежа
- `yookassaWebhook` - Обработка webhook от YooKassa
- `validateBookingRequest` - Валидация лимитов бронирования
- `processRefund` - Обработка возвратов

## Роутинг (firebase.json)

### Основные маршруты
- `/` → `/showcase/showcase.html` (витрина клубов B2C)
- `/admin/**` → `/admin/index.html` (админка для владельцев клубов)
- `/club/**` → `/admin/index.html` (страницы клубов)
- `/demo/**` → `/demo/demo.html` (демо версия)
- `/business/**` → `/business/index.html` (B2B лендинг)
- `/fm/**` → `/fm/index.html` (финансовая модель)
- `/showcase/**` → файлы из папки showcase (ассеты витрины)

### API endpoints
- `/api/webhooks/yookassa` → Cloud Function

## Платежная интеграция

### Поддерживаемые провайдеры
- YooKassa (основной)
- T-Bank (альтернативный)

### URL для настройки в платежных системах
- **Webhook URL:** https://allcourt.ru/api/webhooks/yookassa
- **Return URL:** Настраивается для каждого платежа индивидуально

## Безопасность

### Роли пользователей
- `superadmin` - полный доступ
- `admin` - управление клубом
- `trainer` - ограниченный доступ (только просмотр)

### Защищенные страницы
- `/fm` - финансовая модель (пароль: BULAT)

## Администрирование и мониторинг

### Команды для бэкапов
```bash
# Просмотр логов бэкапов
firebase functions:log --only scheduledFirestoreBackup

# Ручной запуск бэкапа
gcloud firestore export gs://sports-booking-backups-1d7e5/manual-$(date +%Y%m%d)

# Проверка существующих бэкапов
gsutil ls gs://sports-booking-backups-1d7e5/backups/

# Восстановление из конкретного бэкапа
gcloud firestore import gs://sports-booking-backups-1d7e5/backups/2025-01-07

# Проверка размера базы данных
gsutil du -sh gs://sports-booking-backups-1d7e5/backups/$(date +%Y-%m-%d)/
```

### Мониторинг системы
- **Cloud Functions:** https://console.cloud.google.com/functions/list?project=sports-booking-app-1d7e5
- **Cloud Storage:** https://console.cloud.google.com/storage/browser/sports-booking-backups-1d7e5
- **Firestore:** Коллекция `backup_logs` для истории операций

## Известные проблемы и решения

### Проблема с датами в календаре
**Проблема:** Старые бронирования отображаются на день раньше
**Решение:** При редактировании даты используется UTC формат, что исправляет отображение

### Firebase Auth visibility error
**Проблема:** `auth/visibility-check-was-unavailable`
**Решение:** Очистить кеш браузера или использовать инкогнито режим

## Контакты и поддержка
- **GitHub Issues:** https://github.com/anthropics/claude-code/issues
- **Firebase Console:** https://console.firebase.google.com/project/sports-booking-app-1d7e5

## Последние обновления (Январь 2025)

### Групповые тренировки
- **Функционал:** Полноценная поддержка групповых тренировок
- **Возможности:**
  - Создание открытых и закрытых групповых тренировок
  - Установка максимального количества участников
  - Добавление участников при создании бронирования
  - Отображение количества участников в календаре (иконка группы)
  - Автоматическая онлайн-оплата для открытых групп
  - Поиск и добавление существующих клиентов
- **Особенности:**
  - При выборе тренера автоматически активируется групповая тренировка
  - Состояние групповой тренировки корректно сбрасывается при закрытии модалки
  - В календаре групповые тренировки отображаются с иконкой Groups

### Календарь бронирований - режимы День/Неделя
- **Новые возможности:**
  - Переключение между режимами "Неделя" и "День"
  - В режиме "День" корты отображаются как колонки
  - Динамический заголовок показывает период или конкретную дату
  - Ограничение ширины колонок кортов (120px)
- **Улучшения интерфейса:**
  - Улучшена видимость линий сетки (#d1d5db)
  - Единообразные фоны для заголовков и ячеек
  - Фиксированная высота заголовков (44px)
  - Режим "По тренеру" доступен только в недельном виде

### Интеграция с T-Bank Multiaccounts
- **Функционал:** Автоматическое распределение платежей между субсчетами
- **Возможности:**
  - Регистрация клубов в системе мультиаккаунтов
  - Автоматические выплаты клубам
  - Обработка возвратов через API T-Bank
  - Статический IP для webhook через Cloud NAT
- **Конфигурация:**
  - Настройки в `/functions/src/config/tbankConfig.ts`
  - Cloud Function: `tbankWebhook` для обработки уведомлений

### Система автоматических бэкапов (Январь 2025)
- **Хранилище:** Cloud Storage bucket `gs://sports-booking-backups-1d7e5/`
- **Расписание:**
  - Ежедневные бэкапы в 3:00 МСК
  - Автоматическая очистка старше 30 дней каждый понедельник
- **Cloud Functions:**
  - `scheduledFirestoreBackup` - автоматические ежедневные бэкапы
  - `manualFirestoreBackup` - ручные бэкапы для superadmin
  - `cleanupOldBackups` - очистка старых бэкапов
- **Что включено:**
  - ВСЕ коллекции Firestore (users, venues, bookings, courts и др.)
  - Вложенные коллекции и поддокументы
  - Метаданные и индексы
  - Текущий размер базы: ~1.64 MB
- **Восстановление:**
  ```bash
  gcloud firestore import gs://sports-booking-backups-1d7e5/backups/YYYY-MM-DD
  ```
- **Мониторинг:** Коллекция `backup_logs` в Firestore

## Последние обновления (Август 2025)

### Витрина клубов (B2C маркетплейс)
- **URL:** https://allcourt.ru
- **Функционал:** 
  - Поиск и фильтрация клубов по городам и видам спорта
  - SEO-оптимизированные URL с динамическими meta-тегами
  - Геолокация для определения ближайшего города
  - Адаптивная верстка с breakpoint 769px для мобильных
  - Динамическая загрузка реквизитов из Firebase
- **Конфигурация:** vite.config.showcase.ts с отключенным publicDir
- **Структура:** React компоненты в /src/components/showcase/

### B2B лендинг для клубов
- **URL:** https://allcourt.ru/business
- **Расположение:** /public/business/
- **Описание:** Статический лендинг для привлечения новых клубов

### Демо версия
- **URL:** https://allcourt.ru/demo
- **Конфигурация:** vite.config.demo.ts
- **База данных:** Подключается к продакшн Firebase

### Функционал редактирования бронирований
- Добавлена возможность редактировать корт, дату, длительность и время
- Реализована проверка доступности в реальном времени
- История изменений отображается в деталях бронирования

### Финансовая модель
- Создан защищенный лендинг на /fm
- Детальная модель с комиссией 1% от бронирований
- Прогнозы на 3 года с unit economics

### Исправления
- Корректное сохранение дат в UTC для календаря
- Улучшено отображение URL в настройках оплаты
- Исправлен returnUrl для успешной оплаты
- Исправлена структура папок для избежания конфликтов

### Фильтрация по видам спорта (29 августа 2025)
**ВАЖНОЕ ИЗМЕНЕНИЕ:** Изменена логика определения видов спорта для клубов

#### Старая логика (устарела):
- Поле `sports` у клуба заполнялось при парсинге из Яндекс
- Виды спорта определялись из тегов (анализ названия и описания)
- При регистрации через парсер в `sportTypes` записывалось ["padel"], ["tennis"] или ["badminton"] на основе тегов

#### Новая логика:
- **Виды спорта определяются исключительно из настроек кортов** (поле `sportType` у каждого корта)
- При загрузке клубов автоматически загружаются все корты и извлекаются уникальные виды спорта
- Добавлено новое поле `courtSportTypes` - массив видов спорта из кортов
- Поле `sports` считается устаревшим (deprecated)

#### Изменения в коде:
**Витрина (showcase):**
- При загрузке в `src/pages/showcase/App.tsx` для каждого клуба загружаются корты
- Виды спорта сохраняются в `venue.courtSportTypes`
- Фильтрация проверяет только `courtSportTypes`

**Мобильное приложение (Flutter):**
- `VenueService.getVenues()` загружает корты для каждого клуба
- `VenueModel.courtSportTypes` хранит виды спорта из кортов
- Фильтрация в `VenuesProvider` использует `courtSportTypes`

#### Особенности:
- **Клубы без кортов не показываются при фильтрации по конкретному виду спорта**
- Клубы без кортов видны только в фильтре "Все виды"
- Обеспечивается единообразие - виды спорта соответствуют реальным кортам

### Автоматическое создание кортов при парсинге (29 августа 2025)
**Новый функционал:** При регистрации клуба через парсер автоматически создается первый корт

#### Детали реализации:
- При нажатии "Зарегистрировать" в парсере создается корт с названием "Корт 1"
- Вид спорта корта берется из выбранного фильтра парсинга (падел/теннис/бадминтон)
- Автоматически устанавливаются базовые параметры:
  - **Покрытие:** Искусственная трава (падел), Хард (теннис), Синтетический ковер (бадминтон)
  - **Тип:** Крытый корт
  - **Цена:** 3000₽/час (падел), 2500₽/час (теннис), 1500₽/час (бадминтон)
  - **Расписание:** 07:00-23:00 (будни), 08:00-22:00 (выходные)
  - **Макс. игроков:** 4 (падел/бадминтон), 2 (теннис)
- В подписке сразу устанавливается `courtsCount: 1`

#### Структура данных корта:
- **type:** Вид спорта (основное поле для фильтрации) - "padel", "tennis", "badminton"
- **sportType:** Дублирует type для обратной совместимости
- **courtType:** Тип корта - "indoor" (крытый) или "outdoor" (открытый)
- **venueId:** ID клуба-владельца
- **priceWeekday:** Цена в будни
- **priceWeekend:** Цена в выходные

#### Файлы изменений:
- `/src/pages/admin/Parser.tsx` - передача `sportType` в функцию регистрации
- `/functions/src/parser/clubParser.ts` - создание корта в `registerClubFromParser`